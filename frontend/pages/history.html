<!doctype html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Lịch sử - AI Translation System</title>
    <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap"
      rel="stylesheet"
    />
    <link rel="stylesheet" href="/css/theme-dark.css" />
    <link rel="stylesheet" href="/css/home.css" />
    <link rel="stylesheet" href="/css/dashboard.css" />
    <script src="/js/auth_state.js" defer></script>
    <link
      rel="stylesheet"
      href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/css/all.min.css"
    />
    <style>
      .page-wrap {
        padding: 28px 0 60px;
      }
      .history-actions .btn-small {
        cursor: pointer;
      }
    </style>
  </head>

  <body class="theme-dark">
    <nav class="navbar">
      <div class="nav-container">
        <div class="nav-logo">
          <i class="fas fa-language"></i>
          <span>AI Translator</span>
        </div>
        <div class="nav-links">
          <a href="/" class="nav-link">Trang chủ</a>
          <a href="/dashboard" class="nav-link">Dịch thuật</a>
          <a href="/history" class="nav-link active">Lịch sử</a>
          <a href="/profile" class="nav-link">Tài khoản</a>
          <button id="loginBtn" class="btn-login" style="display: none">
            <i class="fas fa-sign-in-alt"></i> Đăng nhập
          </button>
          <button id="logoutBtn" class="btn-login">
            <i class="fas fa-sign-out-alt"></i> Đăng xuất
          </button>
        </div>
      </div>
    </nav>

    <section class="dashboard">
      <div class="container page-wrap">
        <div class="dashboard-header">
          <h1>Lịch sử dịch</h1>
        </div>

        <div
          id="notificationArea"
          class="notification-area"
          style="display: none"
        >
          <div class="notification-content">
            <i class="fas fa-info-circle"></i>
            <span id="notificationText"></span>
            <button onclick="closeNotification()" class="notification-close">
              &times;
            </button>
          </div>
        </div>

        <div class="glassmorphism" style="padding: 18px">
          <div class="history-filters" style="margin-bottom: 14px">
            <select id="historyType" class="lang-select">
              <option value="all">Tất cả</option>
              <option value="text">Văn bản</option>
              <option value="document">Tài liệu</option>
            </select>
            <input type="date" id="historyDate" />
            <button class="btn-secondary" onclick="applyHistoryFilter()">
              <i class="fas fa-filter"></i> Lọc
            </button>
          </div>

          <div id="historyList" class="history-list"></div>

          <div class="pagination" style="margin-top: 14px">
            <button id="prevPage" onclick="changePage(-1)">Trước</button>
            <span id="pageInfo">Trang 1</span>
            <button id="nextPage" onclick="changePage(1)">Sau</button>
          </div>
        </div>
      </div>
    </section>

    <script>
      const state = {
        page: 1,
        pages: 1,
        type: "all",
        date: "",
      };

      function showNotify(message, type = "info") {
        const area = document.getElementById("notificationArea");
        const txt = document.getElementById("notificationText");
        if (!area || !txt) return alert(message);
        txt.textContent = message;
        area.style.display = "block";
        setTimeout(() => {
          area.style.display = "none";
        }, 3500);
      }

      function closeNotification() {
        const area = document.getElementById("notificationArea");
        if (area) area.style.display = "none";
      }

      function getAuthHeaders() {
        const token = localStorage.getItem("token");
        if (token && !String(token).startsWith("fake")) {
          return { Authorization: `Bearer ${token}` };
        }
        return {};
      }

      function ensureLoggedIn() {
        const token = localStorage.getItem("token");
        if (!token) {
          window.location.href = "/auth";
          return false;
        }
        return true;
      }

      function escapeHtml(s) {
        return String(s || "")
          .replace(/&/g, "&amp;")
          .replace(/</g, "&lt;")
          .replace(/>/g, "&gt;")
          .replace(/\"/g, "&quot;")
          .replace(/'/g, "&#39;");
      }

      async function loadHistory() {
        if (!ensureLoggedIn()) return;

        const params = new URLSearchParams({
          page: String(state.page),
          per_page: "10",
          type: state.type,
        });
        if (state.date) params.set("date", state.date);

        const list = document.getElementById("historyList");
        if (list) list.innerHTML = "<p>Đang tải...</p>";

        const resp = await fetch(`/api/history/?${params.toString()}`, {
          headers: {
            ...getAuthHeaders(),
          },
        });
        const data = await resp.json().catch(() => ({}));
        if (!resp.ok) {
          showNotify(
            data.error || data.message || "Không tải được lịch sử",
            "error",
          );
          if (list) list.innerHTML = "<p>Không tải được lịch sử.</p>";
          return;
        }

        state.pages = data.pages || 1;
        renderHistory(
          Array.isArray(data.translations) ? data.translations : [],
        );
        updatePagination();
      }

      function renderHistory(items) {
        const list = document.getElementById("historyList");
        if (!list) return;
        if (!items.length) {
          list.innerHTML = '<p class="no-history">Chưa có lịch sử dịch.</p>';
          return;
        }

        list.innerHTML = items
          .map((item) => {
            const createdAt = item.created_at
              ? new Date(item.created_at).toLocaleString("vi-VN")
              : "";
            const src = escapeHtml(item.source_lang || "");
            const dst = escapeHtml(item.target_lang || "");
            const orig = escapeHtml(item.original_text || "");
            const tran = escapeHtml(item.translated_text || "");
            return `
							<div class="history-item glassmorphism">
								<div class="history-header">
									<span class="history-date">${createdAt}</span>
									<span class="history-lang">${src} → ${dst}</span>
								</div>
								<div class="history-content">
									<div class="original-text"><strong>Nguyên bản:</strong> ${orig}</div>
									<div class="translated-text"><strong>Dịch:</strong> ${tran}</div>
								</div>
								<div class="history-actions">
									<button onclick="copyHistoryItem(${item.id}, this)" class="btn-small">
										<i class="fas fa-copy"></i> Sao chép
									</button>
									<button onclick="deleteHistoryItem(${item.id}, this)" class="btn-small delete">
										<i class="fas fa-trash"></i> Xóa
									</button>
								</div>
							</div>
						`;
          })
          .join("");
      }

      function updatePagination() {
        const pageInfo = document.getElementById("pageInfo");
        const prevBtn = document.getElementById("prevPage");
        const nextBtn = document.getElementById("nextPage");
        if (pageInfo)
          pageInfo.textContent = `Trang ${state.page} / ${state.pages}`;
        if (prevBtn) prevBtn.disabled = state.page <= 1;
        if (nextBtn) nextBtn.disabled = state.page >= state.pages;
      }

      function changePage(delta) {
        const next = state.page + delta;
        if (next < 1 || next > state.pages) return;
        state.page = next;
        loadHistory();
      }

      function applyHistoryFilter() {
        const typeEl = document.getElementById("historyType");
        const dateEl = document.getElementById("historyDate");
        state.type = (typeEl && typeEl.value) || "all";
        state.date = (dateEl && dateEl.value) || "";
        state.page = 1;
        loadHistory();
      }

      async function copyHistoryItem(id, buttonEl) {
        const card = buttonEl ? buttonEl.closest(".history-item") : null;
        const t = card
          ? (card.querySelector(".translated-text") || {}).innerText
          : "";
        const text = (t || "").replace(/^Dịch:\s*/i, "");
        try {
          await navigator.clipboard.writeText(text);
          showNotify("Đã sao chép!", "success");
        } catch (e) {
          showNotify("Không sao chép được", "error");
        }
      }

      async function deleteHistoryItem(id, buttonEl) {
        if (!confirm("Xóa bản dịch này?")) return;
        const resp = await fetch(`/api/history/${id}`, {
          method: "DELETE",
          headers: {
            ...getAuthHeaders(),
          },
        });
        const data = await resp.json().catch(() => ({}));
        if (!resp.ok) {
          showNotify(data.error || data.message || "Xóa thất bại", "error");
          return;
        }
        showNotify("Đã xóa", "success");
        loadHistory();
      }

      document.addEventListener("DOMContentLoaded", () => {
        loadHistory();
      });
    </script>
  </body>
</html>
